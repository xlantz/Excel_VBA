Option Explicit

Sub CreateTemplateSheet()
    Dim wb As Workbook
    Dim srcSheet As Worksheet, destSheet As Worksheet
    Dim newName As String
    Dim headers As Variant
    Dim mapping As Object
    Dim srcHeaders As Range, c As Range
    Dim lastRow As Long, lastCol As Long
    Dim destRow As Long
    Dim colDict As Object
    Dim i As Long
    
    Set wb = ThisWorkbook
    
    ' Name for the new sheet based on the current last sheet
    newName = wb.Sheets(wb.Sheets.Count).Name & " Template"
    
    'Delete sheet if it already exists
    On Error Resume Next
    Application.DisplayAlerts = False
    wb.Sheets(newName).Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    
    'Create new sheet at the end
    Set destSheet = wb.Sheets.Add(After:=wb.Sheets(wb.Sheets.Count))
    destSheet.Name = newName
    
    ' Now that the new sheet exists, the source is the second-to-last
    If wb.Sheets.Count < 2 Then
        MsgBox "Not enough sheets to run this macro.", vbExclamation
        Exit Sub
    End If
    Set srcSheet = wb.Sheets(wb.Sheets.Count - 1)
    
    'Define headers for the new sheet
    headers = Array("Account Number", "Amount", "External Ref Id", "Status", _
                    "Transaction Type", "Channel", "Effective Datetime", _
                    "Method", "Waterfall Override", "Notes")
    
    'Write headers to new sheet
    For i = LBound(headers) To UBound(headers)
        destSheet.Cells(1, i + 1).Value = headers(i)
    Next i
    
    'Mapping old to new (all lowercase for robustness)
    Set mapping = CreateObject("Scripting.Dictionary")
    mapping("loan #") = "Account Number"
    mapping("gross") = "Amount"
    mapping("credit memo") = "External Ref Id"
    mapping("date") = "Effective Datetime"
    mapping("note for account") = "Notes"
    
    'Get header row in source sheet (assume row 1)
    lastCol = srcSheet.Cells(1, srcSheet.Columns.Count).End(xlToLeft).Column
    Set srcHeaders = srcSheet.Range(srcSheet.Cells(1, 1), srcSheet.Cells(1, lastCol))
    
    'Dictionary for source column numbers (normalize text: lowercase + trim)
    Set colDict = CreateObject("Scripting.Dictionary")
    For Each c In srcHeaders
        If Not IsEmpty(c.Value) Then
            colDict(LCase(Trim(c.Value))) = c.Column
        End If
    Next c
    
    'Check if all required headers exist in source
    Dim missingHeaders As String
    missingHeaders = ""
    Dim key As Variant
    For Each key In mapping.Keys
        If Not colDict.exists(key) Then
            missingHeaders = missingHeaders & vbCrLf & "- " & key
        End If
    Next key
    If Len(missingHeaders) > 0 Then
        MsgBox "The following required headers were NOT found in the source sheet:" & missingHeaders, vbCritical
        Exit Sub
    End If
    
    'Find last row of data
    lastRow = srcSheet.Cells(srcSheet.Rows.Count, 1).End(xlUp).Row
    
    destRow = 2
    Dim srcRow As Long
    Dim newCol As Long
    For srcRow = 2 To lastRow
        'Skip blank rows (if the entire row is empty)
        If Application.WorksheetFunction.CountA(srcSheet.Rows(srcRow)) = 0 Then
            GoTo SkipRow
        End If
        
        'Fill mapped values
        For Each key In mapping.Keys
            newCol = GetHeaderColumn(headers, mapping(key))
            If newCol > 0 Then
                destSheet.Cells(destRow, newCol).Value = srcSheet.Cells(srcRow, colDict(key)).Value
            End If
        Next key
        
        'Fixed values
        destSheet.Cells(destRow, GetHeaderColumn(headers, "Status")).Value = 14
        destSheet.Cells(destRow, GetHeaderColumn(headers, "Transaction Type")).Value = "AUCT"
        destSheet.Cells(destRow, GetHeaderColumn(headers, "Waterfall Override")).Value = "PRINCIPAL_BALANCE_REDUCTION"
        
        destRow = destRow + 1
        
SkipRow:
    Next srcRow
    
    MsgBox "Template sheet '" & newName & "' created successfully!", vbInformation
End Sub

' Helper: find header column index by name in VBA array
Function GetHeaderColumn(arr As Variant, headerName As String) As Long
    Dim i As Long
    For i = LBound(arr) To UBound(arr)
        If arr(i) = headerName Then
            GetHeaderColumn = i + 1
            Exit Function
        End If
    Next i
    GetHeaderColumn = 0 'not found
End Function




